<!doctype html>
<html lang="en">
	<head>
		<title>MapLibre Protocol Abort Repro (Remove/Re-add)</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.css" />
		<script src="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.js"></script>
		<style>
			html,
			body,
			#map {
				margin: 0;
				padding: 0;
				height: 100%;
			}
			#controls {
				position: absolute;
				top: 10px;
				left: 10px;
				z-index: 1;
				background: white;
				padding: 15px;
				border-radius: 4px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
				max-width: 300px;
				font-family: sans-serif;
			}
			button {
				padding: 8px 12px;
				cursor: pointer;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<div id="controls">
			<h3>Abort Repro (Remove/Re-add)</h3>
			<p>
				Investigates if tiles are aborted when the source and layer are <b>removed</b> and
				<b>re-added</b> instead of using <code>setUrl()</code>.
			</p>
			<ol>
				<li>Open DevTools Console.</li>
				<li>Observe tiles starting (blue logs).</li>
				<li>Click button before they finish (2s delay).</li>
				<li>Check for "ABORTED" (red logs).</li>
			</ol>
			<button id="update-url">Remove & Re-add Source</button>
		</div>
		<div id="map"></div>
		<script>
			// 1. Register a simple custom protocol with logging and delay
			maplibregl.addProtocol('repro', async (params, abortController) => {
				const url = params.url;
				console.log(`%c[Protocol] Start (${params.type}): ${url}`, 'color: blue');

				// Monitor the abort signal
				abortController.signal.addEventListener('abort', () => {
					console.warn(
						`%c[Protocol] ABORTED (${params.type}): ${url}`,
						'color: red; font-weight: bold'
					);
				});

				// Simulate a slow network request (2 seconds for tiles, 0.2s for JSON)
				const delay = params.type === 'json' ? 200 : 2000;
				await new Promise((resolve) => setTimeout(resolve, delay));

				// Check abort status BEFORE doing expensive work
				if (abortController.signal.aborted) {
					console.log(`%c[Protocol] Ignored after delay: ${url}`, 'color: gray');
					return { data: null };
				}

				if (params.type === 'json') {
					console.log(`%c[Protocol] Complete (${params.type}): ${url}`, 'color: green');
					return {
						data: {
							tilejson: '2.2.0',
							tiles: [url + '&z={z}&x={x}&y={y}'], // Append coords to URL
							minzoom: 0,
							maxzoom: 22
						}
					};
				}

				// --- GENERATE SAMPLE IMAGE DATA ---
				const canvas = document.createElement('canvas');
				canvas.width = 256;
				canvas.height = 256;
				const ctx = canvas.getContext('2d');

				// Use a color based on the version 'v=' in the URL
				const version = new URL(url).searchParams.get('v') || '0';
				const hue = (parseInt(version) * 40) % 360;
				ctx.fillStyle = `hsla(${hue}, 70%, 50%, 0.8)`;
				ctx.fillRect(0, 0, 256, 256);

				// Draw tile info
				ctx.strokeStyle = 'white';
				ctx.lineWidth = 2;
				ctx.strokeRect(5, 5, 246, 246);
				ctx.fillStyle = 'white';
				ctx.font = 'bold 20px sans-serif';
				ctx.fillText(`Version: ${version}`, 20, 40);

				const paramsUrl = new URL(url);
				const z = paramsUrl.searchParams.get('z');
				const x = paramsUrl.searchParams.get('x');
				const y = paramsUrl.searchParams.get('y');
				ctx.fillText(`z:${z} x:${x} y:${y}`, 20, 70);

				// Final check before creating the bitmap
				if (abortController.signal.aborted) return { data: null };

				try {
					const bitmap = await createImageBitmap(canvas);

					// If aborted while creating bitmap, we MUST close it and return null
					// to avoid "An attempt was made to use an object that is no longer usable"
					if (abortController.signal.aborted) {
						bitmap.close();
						return { data: null };
					}

					console.log(`%c[Protocol] Complete (${params.type}): ${url}`, 'color: green');
					return { data: bitmap };
				} catch (e) {
					console.error('Failed to create bitmap', e);
					return { data: null };
				}
			});

			const map = new maplibregl.Map({
				container: 'map',
				style: {
					version: 8,
					sources: {},
					layers: [
						{
							id: 'background',
							type: 'background',
							paint: { 'background-color': '#f0f0f0' }
						}
					]
				},
				center: [0, 0],
				zoom: 2
			});

			let counter = 0;

			map.on('load', () => {
				console.log('Map loaded. Adding source...');

				map.addSource('repro-source', {
					type: 'raster',
					url: `repro://data?v=${counter++}`,
					tileSize: 256
				});

				map.addLayer({
					id: 'repro-layer',
					type: 'raster',
					source: 'repro-source'
				});
			});

			document.getElementById('update-url').addEventListener('click', () => {
				const sourceId = 'repro-source';
				const layerId = 'repro-layer';
				const newUrl = `repro://data?v=${counter++}`;

				console.log(
					`%c>>> Removing and Re-adding source with url: '${newUrl}'`,
					'background: #222; color: #ffcc00; font-weight: bold; padding: 2px 5px;'
				);

				// 1. Remove existing layer and source
				if (map.getLayer(layerId)) map.removeLayer(layerId);
				if (map.getSource(sourceId)) map.removeSource(sourceId);

				// 2. Re-add source with new URL
				map.addSource(sourceId, {
					type: 'raster',
					url: newUrl,
					tileSize: 256
				});

				// 3. Re-add layer
				map.addLayer({
					id: layerId,
					type: 'raster',
					source: sourceId,
					paint: { 'raster-opacity': 0.8 }
				});
			});
		</script>
	</body>
</html>
